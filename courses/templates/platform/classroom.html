{% extends 'platform/base.html' %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-language_tools.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-beautify.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=Inter:wght@300;400;700;900&display=swap');
    
    :root { 
        --v-accent: #007acc; 
        --v-bg: #030303;
        --v-panel: #0a0a0a;
        --v-border: rgba(255,255,255,0.06);
    }

    body { font-family: 'Inter', sans-serif; background: #000; color: #d1d1d1; overflow: hidden; height: 100vh; }
    
    /* MASTER LAYOUT MATRIX */
    .master-matrix {
        display: grid;
        grid-template-columns: 480px 1fr; /* ENLARGED SIDEBAR FOR BIGGER VIDEO */
        grid-template-rows: 60px 1fr 35px;
        height: 100vh;
        background: #000;
        gap: 2px;
    }

    /* HEADER HUD */
    .hud-header { grid-column: 1 / 3; background: var(--v-panel); border-bottom: 1px solid var(--v-border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }

    /* SIDEBAR ARCHITECTURE */
    .sidebar-engine { background: #050505; display: flex; flex-direction: column; border-right: 1px solid var(--v-border); overflow: hidden; }
    
    /* THE VIDEO ENGINE (ENLARGED) */
    .video-viewport {
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #000;
        border-bottom: 1px solid var(--v-border);
        position: relative;
    }
    .video-viewport iframe { width: 100%; height: 100%; filter: contrast(1.1) brightness(0.9); transition: 0.3s; }
    .video-viewport:hover iframe { filter: contrast(1) brightness(1); }

    /* EDITOR CORE */
    .editor-zone { display: flex; flex-direction: column; background: #050505; overflow: hidden; }
    .ace_editor { font-family: 'Fira Code', monospace !important; font-size: 14px !important; background: transparent !important; }
    .ace_gutter { background: #080808 !important; color: #444 !important; border-right: 1px solid var(--v-border); }

    /* TERMINAL OVERLAY (DYNAMIC HEIGHT) */
    .terminal-tray {
        height: 280px;
        background: #000;
        border-top: 1px solid var(--v-border);
        display: flex;
        flex-direction: column;
    }

    /* TELEMETRY ANIMATIONS */
    .scanline { width: 100%; height: 100px; z-index: 100; pointer-events: none; position: absolute; background: linear-gradient(0deg, transparent 0%, rgba(0,122,204,0.03) 50%, transparent 100%); animation: scan 12s linear infinite; }
    @keyframes scan { from { top: -100px; } to { top: 100%; } }

    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #1a1a1a; border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: var(--v-accent); }
</style>

<div class="master-matrix">
    <div class="scanline"></div>

    <nav class="hud-header">
        <div class="flex items-center gap-10">
            <div class="flex flex-col">
                <span class="text-[10px] font-black text-blue-500 tracking-[0.4em] uppercase">Leviathan_Singularity</span>
                <span class="text-xs font-black text-white italic">HYPER_STABLE_v10.2</span>
            </div>
            <div class="flex gap-8 border-l border-white/10 pl-8">
                <div class="flex flex-col">
                    <span class="text-[7px] font-bold text-gray-500 uppercase">Core_Load</span>
                    <span id="load-val" class="text-[10px] font-mono text-green-500">0.00%</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-[7px] font-bold text-gray-500 uppercase">Memory_Leak_Check</span>
                    <span class="text-[10px] font-mono text-blue-400">NOMINAL</span>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div id="status-text" class="text-[9px] font-black text-blue-500 uppercase tracking-widest">WASM_READY</div>
                <div id="sub-status" class="text-[7px] font-bold text-gray-600 uppercase">Encryption: AES_256</div>
            </div>
            <button onclick="masterRun()" class="px-16 py-3 bg-white text-black text-[11px] font-black rounded-sm hover:bg-blue-600 hover:text-white transition-all transform active:scale-95 shadow-2xl uppercase tracking-tighter">
                Execute_Kernel
            </button>
        </div>
    </nav>

    <aside class="sidebar-engine">
        <div class="video-viewport">
            <iframe id="video-engine" src="https://www.youtube.com/embed/{{ course.video_id }}?rel=0" frameborder="0" allowfullscreen></iframe>
        </div>
        
        <div class="flex-1 p-6 overflow-y-auto custom-scroll">
            <div class="flex items-center justify-between border-b border-white/5 pb-3 mb-5">
                <span class="text-[10px] font-black text-white uppercase tracking-widest">Register_Memory_Stack</span>
                <div class="flex gap-1">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-[8px] text-gray-600 font-mono">LIVE</span>
                </div>
            </div>
            <div id="mem-map" class="space-y-1">
                <div class="text-[10px] font-mono text-gray-800 text-center py-20 italic">NULL_ALLOCATION_PTR</div>
            </div>
            
            <div class="mt-10 border-t border-white/5 pt-6">
                <span class="text-[10px] font-black text-blue-500 uppercase tracking-widest block mb-4">Module_Documentation</span>
                <div class="text-[11px] text-gray-500 leading-relaxed font-mono italic opacity-60">
                    {{ course.description|linebreaks }}
                </div>
            </div>
        </div>
    </aside>

    <div class="editor-zone">
        <div class="h-10 bg-[#080808] flex items-center justify-between px-6 border-b border-white/5">
            <div class="flex items-center gap-4 h-full">
                <div class="h-full px-4 border-t-2 border-blue-500 flex items-center gap-2 bg-[#050505]">
                    <span id="tab-icon">‚öôÔ∏è</span>
                    <span id="tab-label" class="text-[10px] font-black text-white uppercase tracking-widest">kernel.cpp</span>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="beautify()" class="text-[9px] font-black text-gray-500 hover:text-white transition-colors">BEAUTIFY_SRC</button>
            </div>
        </div>

        <div class="flex-1 relative">
            <div id="editor" class="absolute inset-0"></div>
        </div>

        <section class="terminal-tray">
            <div class="h-9 bg-[#080808] flex items-center justify-between px-6 border-b border-white/5">
                <span class="text-[10px] font-black text-blue-500 uppercase tracking-widest">Std_Out_Buffer</span>
                <span id="exec-bench" class="text-[9px] font-mono text-gray-600">--ms</span>
            </div>
            <div id="term-body" class="flex-1 p-6 font-mono text-[13px] overflow-y-auto custom-scroll bg-black/40">
                <div id="term-log" class="space-y-1"></div>
            </div>
        </section>
    </div>

    <footer class="hud-header !h-[35px] !bg-blue-600 border-none px-6">
        <div class="flex gap-12 text-white text-[10px] font-black italic">
            <span id="cur-pos">LN 1, COL 1</span>
            <span>SYSTEM_THREAD: 0x{{ "now"|date:"is" }}</span>
        </div>
        <span class="text-white text-[10px] font-black uppercase opacity-70">Security: TLS_1.3_ENCRYPTED</span>
    </footer>
</div>



<script>
    /**
     * HYPER-SINGULARITY KERNEL CORE
     */
    let editor, pyodide;
    const isPy = "{{ course.title }}".toLowerCase().includes("python");

    const VM = {
        registers: {},
        reset() { this.registers = {}; this.syncHUD(); },
        set(k, v) { this.registers[k] = v; this.syncHUD(); },
        syncHUD() {
            const map = document.getElementById('mem-map');
            const entries = Object.entries(this.registers);
            if (entries.length === 0) {
                map.innerHTML = '<div class="text-[10px] font-mono text-gray-800 text-center py-20 italic">NULL_ALLOCATION_PTR</div>';
                return;
            }
            map.innerHTML = entries.map(([k, v]) => `
                <div class="flex justify-between items-center text-[11px] font-mono border-b border-white/5 py-2 hover:bg-white/5 px-2 transition-all">
                    <div class="flex items-center gap-3">
                        <span class="text-gray-700 text-[9px]">0x${Math.abs(k.length * 128).toString(16).toUpperCase()}</span>
                        <span class="text-blue-500 font-bold">${k}</span>
                    </div>
                    <span class="text-white">${v}</span>
                </div>
            `).join('');
        }
    };

    async function init() {
        editor = ace.edit("editor");
        editor.setTheme("ace/theme/one_dark");
        editor.session.setMode(isPy ? "ace/mode/python" : "ace/mode/c_cpp");
        editor.setOptions({ enableBasicAutocompletion: true, enableLiveAutocompletion: true, fontSize: "14px", showPrintMargin: false });

        document.getElementById('tab-label').innerText = isPy ? "logic.py" : "kernel.cpp";
        document.getElementById('tab-icon').innerText = isPy ? "üêç" : "‚öôÔ∏è";

        const startCode = `{{ course.initial_code|escapejs }}` || (isPy ? "print('Python VM Active')" : "int signal = 100;\nfor(int i=0; i<5; i++){\n  cout << \"Pulse: \" << i << \" | Strength: \" << signal << endl;\n}");
        editor.setValue(startCode, -1);

        editor.selection.on('changeCursor', () => {
            const pos = editor.getCursorPosition();
            document.getElementById('cur-pos').innerText = `LN ${pos.row + 1}, COL ${pos.column + 1}`;
        });

        if (isPy) {
            pyodide = await loadPyodide();
            logToTerm("VM_BRIDGE: Python WASM Stack Ready.", "blue");
        }
        
        setInterval(() => {
            document.getElementById('load-val').innerText = (Math.random() * 5).toFixed(2) + "%";
        }, 2000);
    }

    function logToTerm(msg, col = 'gray') {
        const colors = { blue: 'text-blue-500 font-bold', green: 'text-green-400', red: 'text-red-500', gray: 'text-gray-500' };
        const line = document.createElement('div');
        line.className = 'flex gap-4 px-2 py-0.5 hover:bg-white/5 transition-colors';
        line.innerHTML = `<span class="text-[10px] text-gray-800 font-mono italic">log_trace</span>
                          <span class="text-blue-900 font-black">¬ª</span>
                          <span class="${colors[col] || 'text-gray-300'}">${msg}</span>`;
        document.getElementById('term-log').appendChild(line);
        document.getElementById('term-body').scrollTop = 99999;
    }

    async function masterRun() {
        const t0 = performance.now();
        document.getElementById('term-log').innerHTML = '';
        logToTerm("BOOT_SEQUENCE_INIT...", "blue");

        const src = editor.getValue();
        if (isPy) {
            pyodide.setStdout({ batched: (s) => logToTerm(s, 'gray') });
            try { await pyodide.runPythonAsync(src); } catch(e) { logToTerm(e.message, "red"); }
        } else {
            runISA(src);
        }
        document.getElementById('exec-bench').innerText = (performance.now() - t0).toFixed(2) + "ms";
    }

    function runISA(code) {
        VM.reset();
        const instructions = code.replace(/\/\/.*/g, '').split(/({|}|;)/).map(t => t.trim()).filter(t => t);
        
        for (let i = 0; i < instructions.length; i++) {
            let ins = instructions[i];
            
            // FOR LOOP LOGIC
            if (ins.startsWith("for")) {
                const f = ins.match(/for\s*\(\s*int\s+(\w+)\s*=\s*(\d+)\s*;\s*\1\s*<\s*(\d+)\s*;\s*\1\+\+\s*\)/);
                if (f) {
                    const [_, vName, start, end] = f;
                    const body = instructions[i+2]; 
                    for (let v = parseInt(start); v < parseInt(end); v++) {
                        VM.set(vName, v);
                        parse(body);
                    }
                    i += 3; continue;
                }
            }
            parse(ins);
        }
        logToTerm("PIPE_EXIT_SUCCESS", "blue");
    }

    function parse(ins) {
        if (!ins || ins === "{" || ins === "}") return;
        
        // POINTER MAPPING
        const ptr = ins.match(/(int|float)\s*\*\s*(\w+)\s*=\s*&(\w+)/);
        if (ptr) { VM.set(ptr[2], `ADR(&${ptr[3]})`); return; }

        // ALLOCATION
        const alloc = ins.match(/(int|float|auto)\s+(\w+)\s*=\s*([^;]+)/);
        if (alloc) {
            let ex = alloc[3];
            Object.entries(VM.registers).forEach(([k,v]) => { ex = ex.replace(new RegExp(`\\b${k}\\b`, 'g'), v); });
            try { VM.set(alloc[2], eval(ex)); } catch(e) { VM.set(alloc[2], ex); }
            return;
        }

        // COUT STREAM
        if (ins.startsWith("cout")) {
            let buffer = "";
            ins.split("<<").slice(1).forEach(p => {
                let s = p.trim().replace(/endl|;/g, "");
                if (s.startsWith('"')) buffer += s.replace(/"/g, "");
                else {
                    Object.entries(VM.registers).forEach(([k,v]) => { s = s.replace(new RegExp(`\\b${k}\\b`, 'g'), v); });
                    try { let r = eval(s); if(r !== undefined) buffer += r; } catch(e) { buffer += s; }
                }
            });
            if (buffer) logToTerm(buffer, "green");
        }
    }

    function beautify() { ace.require("ace/ext/beautify").beautify(editor.session); }
    window.onload = init;
</script>
{% endblock %}